FROM python:3.7-slim-buster

ENV PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    unixodbc 

RUN apt-get install -y g++ unixodbc-dev

RUN apt-get update && apt-get install -y gnupg2

RUN apt-get install -y curl

RUN curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -

RUN echo "deb [arch=amd64] https://packages.microsoft.com/ubuntu/18.04/prod bionic \
main" |  tee /etc/apt/sources.list.d/mssql-release.list

RUN apt update

RUN ACCEPT_EULA=Y apt-get install msodbcsql17

WORKDIR /backendServices
COPY backendServices/ backendServices/
COPY sharedServices/ sharedServices/
COPY .env .env
COPY vsts.env vsts.env

RUN sed -i -r "s/DJANGO_APP_TYPE_ADMIN=false/DJANGO_APP_TYPE_ADMIN=false/g" /backendServices/.env
RUN sed -i -r "s/DJANGO_APP_TYPE_BACKEND=true/DJANGO_APP_TYPE_BACKEND=true/g" /backendServices/.env

COPY manage.py manage.py
COPY requirements.txt requirements.txt
COPY cache_remover_script.py cache_remover_script.py
COPY docker/entrypointBackend.sh entrypointBackend.sh
RUN pip3 install -r requirements.txt
RUN chmod a+x entrypointBackend.sh

RUN chmod a+x manage.py

ENTRYPOINT ["/backendServices/entrypointBackend.sh"]
